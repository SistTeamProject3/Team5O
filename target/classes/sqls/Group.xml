<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Group">

<insert id="group_make" parameterType="sist.co.model.GroupMakeDTO">
INSERT INTO TP3_MAKEGROUP(G_SEQ,G_NAME,G_TYPE,G_MANAGER)
VALUES(TP3_GROUP_SEQ.NEXTVAL,#{g_name},#{g_type},#{g_manager})

</insert>

<select id="select_make_group" parameterType="sist.co.model.GroupMakeDTO" resultType="sist.co.model.GroupMakeDTO">
SELECT * FROM TP3_MAKEGROUP
WHERE G_MANAGER=#{g_manager} AND G_SEQ=(SELECT MAX(G_SEQ) FROM TP3_MAKEGROUP)
</select>
<insert id="add_group_manager" parameterType="sist.co.model.GroupMemberDTO">
INSERT INTO TP3_GROUPMEMBER
VALUES(#{g_seq},#{m_id},3)
</insert>

<select id="group_list" parameterType="sist.co.model.GroupListDTO" resultType="sist.co.model.GroupListDTO">

SELECT A.G_SEQ,A.M_ID,A.G_AUTH,B.G_NAME,B.G_PHOTO,B.G_TYPE,B.G_MANAGER 
FROM TP3_GROUPMEMBER A,TP3_MAKEGROUP B
WHERE A.G_SEQ=B.G_SEQ AND M_ID=#{m_id}
</select>

<select id="group_detail" parameterType="sist.co.model.GroupMakeDTO" resultType="sist.co.model.GroupMakeDTO">
SELECT * FROM TP3_MAKEGROUP
WHERE G_SEQ=#{g_seq}
</select>

<select id="group_mem_list" parameterType="sist.co.model.GroupMakeDTO" resultType="sist.co.model.GroupMemberListDTO">
SELECT TP3_MEMBER.M_ID,m_name, m_nickname, m_highschool, m_university, m_office, m_address,m_profile, g_seq, g_auth
FROM TP3_MEMBER
INNER JOIN TP3_GROUPMEMBER 
ON TP3_MEMBER.M_ID=TP3_GROUPMEMBER.M_ID
WHERE G_SEQ=#{g_seq} AND M_NAME LIKE '%'||#{keyword}||'%'

</select>

<select id="group_mem_admin_list" parameterType="sist.co.model.GroupMakeDTO" resultType="sist.co.model.GroupMemberListDTO">
SELECT TP3_MEMBER.M_ID,m_name, m_nickname, m_highschool, m_university, m_office, m_address,m_profile, g_seq, g_auth
FROM TP3_MEMBER
INNER JOIN TP3_GROUPMEMBER 
ON TP3_MEMBER.M_ID=TP3_GROUPMEMBER.M_ID
WHERE G_SEQ=#{g_seq} AND G_AUTH=3 AND M_NAME LIKE '%'||#{keyword}||'%'
</select>

<select id="group_mem_reply_list" parameterType="sist.co.model.GroupMakeDTO" resultType="sist.co.model.GroupMemberListDTO">
SELECT TP3_MEMBER.M_ID,m_name, m_nickname, m_highschool, m_university, m_office, m_address,m_profile, g_seq, g_auth
FROM TP3_MEMBER
INNER JOIN TP3_GROUPMEMBER 
ON TP3_MEMBER.M_ID=TP3_GROUPMEMBER.M_ID
WHERE G_SEQ=#{g_seq} AND G_AUTH=2 AND M_NAME LIKE '%'||#{keyword}||'%'
</select>

<select id="group_mem_block_list" parameterType="sist.co.model.GroupMakeDTO" resultType="sist.co.model.GroupMemberListDTO">
SELECT TP3_MEMBER.M_ID,m_name, m_nickname, m_highschool, m_university, m_office, m_address,m_profile, g_seq, g_auth
FROM TP3_MEMBER
INNER JOIN TP3_GROUPMEMBER 
ON TP3_MEMBER.M_ID=TP3_GROUPMEMBER.M_ID
WHERE G_SEQ=#{g_seq} AND G_AUTH=0 AND M_NAME LIKE '%'||#{keyword}||'%'
</select>

<select id="recommend_group_list" parameterType="sist.co.model.GroupListDTO" resultType="sist.co.model.GroupMakeDTO" ><![CDATA[
SELECT * FROM( 
SELECT a.*, rownum as rnum FROM TP3_MAKEGROUP a
WHERE G_SEQ NOT IN(SELECT G_SEQ FROM TP3_GROUPMEMBER
WHERE M_ID=#{m_id}) 
ORDER BY G_SEQ
)WHERE rnum BETWEEN #{s_num} AND #{l_num}

]]></select>

<insert id="groupimageUpload" parameterType="sist.co.model.GroupMakeDTO">
UPDATE TP3_MAKEGROUP SET G_PHOTO=#{g_photo}
WHERE G_SEQ=#{g_seq}
</insert>

<select id="group_photo" parameterType="sist.co.model.GroupMakeDTO" resultType="sist.co.model.GroupPhotoDTO">
SELECT TP3_NEWSFEED.N_SEQ, TP3_NEWSFEED.G_SEQ, TP3_NEWSFEED.N_FORM_NUM, TP3_NEWSFEED.M_ID, TP3_NEWSFEED.N_CONTENT, TP3_NEWSFEED.N_TAG_FRIEND,
TP3_NEWSFEED.N_TAG_WHERE, TP3_NEWSFEED.N_TAG_FEEL, TP3_NEWSFEED.N_SHOW, TP3_NEWSFEED.N_WDATE, TP3_NEWSFEED.N_REPORT,
TP3_NEWSFEED.N_REF, TP3_NEWSFEED.N_STEP, TP3_NEWSFEED.N_DEPTH, TP3_NEWSFEED.N_DEL, TP3_NEWSFEED.N_SHARE, TP3_NEWSFEED.N_EVENT_SEQ,
TP3_NEWSFEED.N_VOTE_SEQ, TP3_NEWSFEED_FILE.NF_PHOTO, TP3_NEWSFEED_FILE.NF_VIDEO, TP3_NEWSFEED_FILE.NF_FILE
FROM TP3_NEWSFEED 
INNER JOIN TP3_NEWSFEED_FILE 
ON TP3_NEWSFEED.N_SEQ=TP3_NEWSFEED_FILE.N_SEQ
WHERE G_SEQ=#{g_seq} AND NF_PHOTO IS NOT NULL
ORDER BY N_WDATE DESC
</select>

<select id="group_video" parameterType="sist.co.model.GroupMakeDTO" resultType="sist.co.model.GroupPhotoDTO">
SELECT TP3_NEWSFEED.N_SEQ, TP3_NEWSFEED.G_SEQ, TP3_NEWSFEED.N_FORM_NUM, TP3_NEWSFEED.M_ID, TP3_NEWSFEED.N_CONTENT, TP3_NEWSFEED.N_TAG_FRIEND,
TP3_NEWSFEED.N_TAG_WHERE, TP3_NEWSFEED.N_TAG_FEEL, TP3_NEWSFEED.N_SHOW, TP3_NEWSFEED.N_WDATE, TP3_NEWSFEED.N_REPORT,
TP3_NEWSFEED.N_REF, TP3_NEWSFEED.N_STEP, TP3_NEWSFEED.N_DEPTH, TP3_NEWSFEED.N_DEL, TP3_NEWSFEED.N_SHARE, TP3_NEWSFEED.N_EVENT_SEQ,
TP3_NEWSFEED.N_VOTE_SEQ, TP3_NEWSFEED_FILE.NF_PHOTO, TP3_NEWSFEED_FILE.NF_VIDEO, TP3_NEWSFEED_FILE.NF_FILE
FROM TP3_NEWSFEED
INNER JOIN TP3_NEWSFEED_FILE
ON TP3_NEWSFEED.N_SEQ=TP3_NEWSFEED_FILE.N_SEQ
WHERE G_SEQ=#{g_seq} AND NF_VIDEO IS NOT NULL
ORDER BY N_WDATE DESC
</select>


<insert id="make_vote" parameterType="sist.co.model.VoteDTO">
INSERT INTO TP3_VOTE (G_SEQ, N_VOTE_SEQ, VOTE1, VOTE2, VOTE3, VOTE4, VOTE5, VOTE6, VOTE7, VOTE8, VOTE9, VOTE10, N_CONTENT, M_ID,S_DATE,M_DATE)
VALUES(#{g_seq},TP3_VOTE_SEQ.NEXTVAL,#{vote1},#{vote2},#{vote3},#{vote4},#{vote5},#{vote6},#{vote7},#{vote8},#{vote9},#{vote10},#{n_content},#{m_id},SYSDATE, SYSDATE)
</insert>

<select id="select_make_vote" parameterType="sist.co.model.VoteDTO" resultType="sist.co.model.VoteDTO">
SELECT * FROM TP3_VOTE
WHERE G_SEQ=#{g_seq} AND N_VOTE_SEQ=(SELECT MAX(N_VOTE_SEQ) FROM TP3_VOTE)
</select>

<insert id="add_vote" parameterType="sist.co.model.VotelistDTO">
INSERT INTO TP3_VOTELIST(N_VOTE_SEQ,V_LIST,V_COUNT)
VALUES(#{n_vote_seq},#{v_list},0)
</insert>

<insert id="add_newsfeed" parameterType="sist.co.model.VoteDTO">
INSERT INTO TP3_NEWSFEED(N_SEQ, N_FORM_NUM, M_ID, N_CONTENT, N_SHOW, N_WDATE ,N_REF, N_STEP, N_DEPTH, N_VOTE_SEQ)
VALUES(TP3_NEWSFEED_SEQ.NEXTVAL, 4, #{m_id}, #{n_content}, 5, SYSDATE, 0,0,0,${n_vote_seq})
</insert>
<select id="filelist" parameterType="sist.co.model.GroupMakeDTO" resultType="sist.co.model.GroupPhotoDTO">
SELECT TP3_NEWSFEED.N_SEQ, TP3_NEWSFEED.G_SEQ, TP3_NEWSFEED.N_FORM_NUM, TP3_NEWSFEED.M_ID, TP3_NEWSFEED.N_CONTENT, TP3_NEWSFEED.N_TAG_FRIEND,
TP3_NEWSFEED.N_TAG_WHERE, TP3_NEWSFEED.N_TAG_FEEL, TP3_NEWSFEED.N_SHOW, TP3_NEWSFEED.N_WDATE, TP3_NEWSFEED.N_REPORT,
TP3_NEWSFEED.N_REF, TP3_NEWSFEED.N_STEP, TP3_NEWSFEED.N_DEPTH, TP3_NEWSFEED.N_DEL, TP3_NEWSFEED.N_SHARE, TP3_NEWSFEED.N_EVENT_SEQ,
TP3_NEWSFEED.N_VOTE_SEQ, TP3_NEWSFEED_FILE.NF_PHOTO, TP3_NEWSFEED_FILE.NF_VIDEO, TP3_NEWSFEED_FILE.NF_FILE
FROM TP3_NEWSFEED 
INNER JOIN TP3_NEWSFEED_FILE 
ON TP3_NEWSFEED.N_SEQ=TP3_NEWSFEED_FILE.N_SEQ
WHERE G_SEQ=#{g_seq} AND NF_PHOTO IS NOT NULL OR NF_VIDEO IS NOT NULL OR NF_FILE IS NOT NULL 
ORDER BY N_WDATE DESC
</select>

<select id="upfilelist" parameterType="sist.co.model.GroupMakeDTO" resultType="sist.co.model.GroupPhotoDTO">
SELECT TP3_NEWSFEED.N_SEQ, TP3_NEWSFEED.G_SEQ, TP3_NEWSFEED.N_FORM_NUM, TP3_NEWSFEED.M_ID, TP3_NEWSFEED.N_CONTENT, TP3_NEWSFEED.N_TAG_FRIEND,
TP3_NEWSFEED.N_TAG_WHERE, TP3_NEWSFEED.N_TAG_FEEL, TP3_NEWSFEED.N_SHOW, TP3_NEWSFEED.N_WDATE, TP3_NEWSFEED.N_REPORT,
TP3_NEWSFEED.N_REF, TP3_NEWSFEED.N_STEP, TP3_NEWSFEED.N_DEPTH, TP3_NEWSFEED.N_DEL, TP3_NEWSFEED.N_SHARE, TP3_NEWSFEED.N_EVENT_SEQ,
TP3_NEWSFEED.N_VOTE_SEQ, TP3_NEWSFEED_FILE.NF_PHOTO, TP3_NEWSFEED_FILE.NF_VIDEO, TP3_NEWSFEED_FILE.NF_FILE
FROM TP3_NEWSFEED 
INNER JOIN TP3_NEWSFEED_FILE 
ON TP3_NEWSFEED.N_SEQ=TP3_NEWSFEED_FILE.N_SEQ
WHERE G_SEQ=#{g_seq} AND NF_PHOTO IS NOT NULL OR NF_VIDEO IS NOT NULL
ORDER BY N_WDATE DESC
</select>

<insert id="group_join_request" parameterType="sist.co.model.GroupRequestDTO">
INSERT INTO TP3_GROUPJOIN(J_SEQ,G_SEQ,G_MANAGER,M_ID,G_ACCEPT,R_DATE)
VALUES(TP3_JOIN_REQ_SEQ.NEXTVAL,#{g_seq},#{g_manager},#{m_id},0,SYSDATE)
</insert>

</mapper>

